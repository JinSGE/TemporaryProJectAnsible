---
# 1. 클러스터 초기화
# [Logical Architecture 적용: 데이터 처리/API 모듈이 돌아갈 클러스터의 기반 생성]
# - Flannel CNI와 호환되는 10.244.0.0/16 대역을 Pod 네트워크로 설정.
# - 'creates' 옵션을 사용하여 이미 초기화된 경우 중복 실행되지 않도록 안전장치를 마련.
- name: 1. 쿠버네티스 마스터 노드 초기화 (kubeadm init)
  ansible.builtin.shell: |
    kubeadm init --pod-network-cidr=10.244.0.0/16
  args:
    creates: /etc/kubernetes/admin.conf
  register: kube_init
  failed_when: 
    - kube_init.rc != 0 
    - '"already exists" not in kube_init.stderr'

# 2. 관리자 설정 디렉토리 준비
# kubectl 명령어를 root 사용자가 바로 사용할 수 있도록 환경을 조성.
- name: 2. kubectl 설정 디렉토리 생성 (.kube)
  ansible.builtin.file:
    path: /root/.kube
    state: directory
    owner: root
    group: root
    mode: '0755'

# 3. 인증 설정 파일 복사
# 클러스터 관리 권한이 담긴 admin.conf 파일을 사용자 홈 디렉토리로 배치.
- name: 3. 관리자 인증 설정 파일(kubeconfig) 배치
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    remote_src: yes
    owner: root
    group: root
    mode: '0600'

# 4. 네트워크 플러그인(CNI) 설치
# [Physical Architecture 적용: VMware 내부 5대 서버 간의 컨테이너 통신망 구축]
# - Flannel을 설치하여 노드 간 Pod 통신이 가능하게 함.
- name: 4. Pod 네트워크 플러그인(Flannel) 설치
  ansible.builtin.shell: |
    kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
  register: cni_result
  changed_when: "'created' in cni_result.stdout or 'configured' in cni_result.stdout"

# 5. 마스터 노드 스케줄링 제약 제거
# [가이드라인 반영: 소규모 클러스터(5대) 환경에서 자원 효율을 극대화]
# - 기본적으로 마스터 노드에는 Pod이 배포되지 않으나, 
#   이를 허용하여 마스터 노드 자원도 활용.
# [Logical Architecture: 노드 이름의 대소문자 불일치 충돌 방지]
- name: 5. 마스터 노드 테인트(Taint) 제거
  ansible.builtin.shell: |
    # 노드 이름을 소문자로 처리하거나, label을 이용해 타겟팅.
    kubectl patch node {{ ansible_hostname | lower }} -p '{"spec":{"taints":[]}}'
  register: taint_remove
  # 이미 테인트가 없는 경우 "not found" 혹은 "not patched"가 뜰 수 있으므로 유연하게 처리
  failed_when: 
    - taint_remove.rc != 0
    - '"not found" not in taint_remove.stderr'
  ignore_errors: yes